# Fixing Random Freezes on ASUS ROG Zephyrus G14 2025 (RTX 5070 Ti) with Ubuntu 24.04

## Problem Summary

**Laptop:** ASUS ROG Zephyrus G14 2025 (GA403WR)  
**GPU:** NVIDIA GeForce RTX 5070 Ti Laptop (12GB)  
**iGPU:** AMD Radeon 890M  
**OS:** Ubuntu 24.04 LTS  
**Kernel:** 6.14.0-37-generic  
**Driver:** nvidia-driver-580-open (580.95.05)

### Symptoms
- Random system freezes on internal laptop display
- External monitor continues working when internal display freezes
- Freezes occur regardless of workload (idle, browsing, light use)
- Mouse/keyboard unresponsive during freeze
- System logs show no obvious errors

### Key Observation
The fact that external monitors remained stable while the internal display froze was the critical clue that led to the solution.

---

## Root Cause Analysis

### Laptop Architecture
The ASUS G14 2025 has a hybrid graphics setup with a MUX switch:
- **Internal display (eDP-1-1):** Wired to AMD Radeon 890M iGPU
- **External ports (HDMI/USB-C):** Wired to NVIDIA RTX 5070 Ti dGPU
- **MUX switch:** Can route displays between GPUs

### The Problem
When using Ubuntu's default NVIDIA PRIME configuration in "on-demand" mode, the system was incorrectly configured:

1. Desktop rendering was using **NVIDIA** (via `prime-select on-demand`)
2. To display on the internal screen, frames had to be:
   - Rendered by NVIDIA dGPU
   - Copied/routed through AMD iGPU 
   - Sent to internal display

This **cross-GPU frame routing** is inherently unstable and caused the freezes.

### Why External Monitors Worked
External ports are directly wired to NVIDIA, so no cross-GPU routing was needed - frames went directly from NVIDIA to the external display.

---

## The Solution

### Overview
Use `supergfxctl` (part of the `asusctl` suite) to properly manage hybrid graphics instead of NVIDIA's `prime-select`. Configure the system so:
- **Desktop renders with AMD** (internal display's native GPU)
- **NVIDIA available on-demand** for compute workloads
- **No cross-GPU routing** for display output

### Step-by-Step Fix

#### 1. Install ASUS Control Software

```bash
sudo add-apt-repository ppa:supergfxd/supergfxd
sudo apt update
sudo apt install supergfxctl asusctl
```

#### 2. Remove NVIDIA Module Blacklist

The system file `/lib/modprobe.d/blacklist-nvidia.conf` (created by `nvidia-prime`) contains aliases that prevent NVIDIA modules from loading in hybrid mode:

```bash
# Backup the file
sudo cp /lib/modprobe.d/blacklist-nvidia.conf /lib/modprobe.d/blacklist-nvidia.conf.bak

# Remove the problematic alias lines
sudo sed -i '/^alias nvidia/d' /lib/modprobe.d/blacklist-nvidia.conf

# Verify the file now only contains blacklist lines
cat /lib/modprobe.d/blacklist-nvidia.conf
```

The file should look like:
```
# Do not modify
# This file was generated by nvidia-prime
blacklist nvidia
blacklist nvidia-drm
blacklist nvidia-modeset
```

#### 3. Configure Hybrid Mode

Edit supergfxd configuration:

```bash
sudo nano /etc/supergfxd.conf
```

Change mode to `"Hybrid"`:
```json
{
  "mode": "Hybrid",
  "vfio_enable": false,
  "vfio_save": false,
  "compute_save": false,
  "always_reboot": false,
  "no_logind": false,
  "logout_timeout_s": 180,
  "hotplug_type": "None"
}
```

#### 4. Reboot

```bash
sudo reboot
```

#### 5. Verify Configuration

After reboot, verify the setup:

```bash
# Check mode
supergfxctl -g
# Output: Hybrid

# Desktop should use AMD
glxinfo | grep "OpenGL renderer"
# Output: AMD Radeon Graphics (radeonsi, gfx1150, ...)

# NVIDIA should be available but suspended when idle
nvidia-smi
# Should show RTX 5070 Ti

# Test NVIDIA on-demand
__NV_PRIME_RENDER_OFFLOAD=1 __GLX_VENDOR_LIBRARY_NAME=nvidia glxinfo | grep "OpenGL renderer"
# Output: NVIDIA GeForce RTX 5070 Ti Laptop GPU
```

---

## Using NVIDIA for ML/CUDA Workloads

### For CUDA Applications (PyTorch, TensorFlow, etc.)
CUDA applications automatically use NVIDIA - no environment variables needed:

```bash
python train_model.py  # Automatically uses NVIDIA
docker run --gpus all pytorch/pytorch:latest python script.py
```

### For OpenGL/Vulkan Applications
Use environment variables to explicitly select NVIDIA:

```bash
__NV_PRIME_RENDER_OFFLOAD=1 __GLX_VENDOR_LIBRARY_NAME=nvidia your_app
```

Or set them globally in your session:
```bash
export __NV_PRIME_RENDER_OFFLOAD=1
export __GLX_VENDOR_LIBRARY_NAME=nvidia
```

---

## Power Management & Battery Life

### Automatic GPU Suspension
In Hybrid mode, NVIDIA automatically suspends when idle:

```bash
# Check GPU power state
cat /sys/bus/pci/devices/0000:64:00.0/power/runtime_status
# Output: suspended (when idle)
```

### Battery Life Comparison
- **Hybrid mode:** 5-7 hours (NVIDIA suspends when idle)
- **Integrated mode:** 6-8 hours (NVIDIA completely disabled)
- **AsusMuxDgpu mode:** 2-3 hours (NVIDIA always active)

### Switching Modes
For maximum battery life when CUDA isn't needed:

```bash
# Switch to Integrated (AMD only)
sudo nano /etc/supergfxd.conf
# Change to: "mode": "Integrated"
sudo reboot

# Switch back to Hybrid when you need NVIDIA
# Change to: "mode": "Hybrid"
sudo reboot
```

---

## Additional Configuration (Optional)

### Kernel Parameters
Add these to `/etc/default/grub` for better stability:

```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash nvidia-drm.modeset=1 nvidia_drm.fbdev=1 amdgpu.dcdebugmask=0x10 nouveau.modeset=0 ibt=off"
```

Update GRUB:
```bash
sudo update-grub
sudo reboot
```

### NVIDIA Module Options
Create `/etc/modprobe.d/nvidia.conf`:

```bash
options nvidia NVreg_PreserveVideoMemoryAllocations=1
options nvidia NVreg_TemporaryFilePath=/var/tmp
options nvidia-drm modeset=1 fbdev=1
```

---

## Troubleshooting

### nvidia-smi Shows Delay When Loading
This is **normal and expected**. When NVIDIA is suspended for power savings:
1. First `nvidia-smi` call wakes GPU (~2-3 seconds)
2. Subsequent calls are instant while GPU is awake
3. GPU suspends again after ~5-10 seconds of inactivity

This delay does **not** affect ML workloads - once your CUDA application starts, the GPU stays awake for the entire session.

### NVIDIA Modules Won't Load
If you see modprobe errors, check for conflicting aliases:

```bash
grep -r "alias nvidia" /etc/modprobe.d/ /lib/modprobe.d/
```

Remove any `alias nvidia off` or `alias nvidia-drm off` lines.

### Desktop Still Uses NVIDIA
Check your session type:

```bash
echo $XDG_SESSION_TYPE
```

- **Wayland:** Handles hybrid graphics automatically (recommended)
- **X11:** May need additional xorg.conf configuration

### System Still Freezes
If freezes persist after following this guide:
1. Verify you're in Hybrid mode: `supergfxctl -g`
2. Verify desktop uses AMD: `glxinfo | grep "OpenGL renderer"`
3. Check supergfxd logs: `sudo journalctl -u supergfxd -n 50`
4. Try Integrated mode temporarily to confirm it's graphics-related

---

## Why This Fixes The Problem

### Before (Broken Configuration)
```
Desktop Rendering (GNOME/Apps)
    ↓
NVIDIA RTX 5070 Ti (dGPU)
    ↓
Frame Copy/Route to AMD 890M (iGPU)
    ↓
Internal Display (eDP-1-1)
    ↓
FREEZES (unstable cross-GPU routing)
```

### After (Fixed Configuration)
```
Desktop Rendering (GNOME/Apps)
    ↓
AMD Radeon 890M (iGPU)
    ↓
Internal Display (eDP-1-1)
    ↓
STABLE (direct path, no routing)

ML/CUDA Workloads
    ↓
NVIDIA RTX 5070 Ti (dGPU)
    ↓
Pure Compute (no display involvement)
```

---

## Technical Details

### What is supergfxctl?
`supergfxctl` is part of the ASUS Linux project (`asusctl`) that provides proper hybrid graphics support for ASUS ROG laptops. It handles:
- GPU mode switching (Integrated/Hybrid/AsusMuxDgpu)
- Proper module loading/unloading
- Power management
- MUX switch control (on supported models)

### Available Modes
- **Integrated:** AMD only, NVIDIA powered off (best battery)
- **Hybrid:** Both GPUs active, AMD for desktop, NVIDIA on-demand (balanced)
- **AsusMuxDgpu:** MUX switches to NVIDIA for all displays (best performance for gaming)

### Why Not Use prime-select?
NVIDIA's `prime-select` tool doesn't understand ASUS's MUX switch architecture and display routing. It can create the exact unstable configuration that causes freezes. `supergfxctl` is specifically designed for ASUS ROG hybrid graphics systems.

---

## System Requirements

- ASUS ROG laptop with hybrid graphics (tested on G14 2025)
- Ubuntu 24.04 or later (may work on 22.04)
- NVIDIA 550+ drivers (580 recommended for RTX 50-series)
- Kernel 6.8+ (6.14+ recommended)

---

## Results After Fix

✅ **No more random freezes**  
✅ **Stable desktop experience on internal display**  
✅ **Full NVIDIA CUDA access for ML workloads**  
✅ **Automatic GPU power management (5-7h battery life)**  
✅ **Docker GPU support working perfectly**  
✅ **External monitors continue to work flawlessly**

---

## Where to Share This Solution

### GitHub
Create a repository or gist with this guide for easy linking and updates.

### Forums & Communities
- **ASUS ROG Reddit:** [r/ASUS](https://reddit.com/r/ASUS) and [r/ASUSROG](https://reddit.com/r/ASUSROG)
- **Ubuntu Forums:** [Ubuntu Community](https://ubuntuforums.org/)
- **ASUS Linux Project:** [asus-linux.org discussions](https://asus-linux.org/)
- **Stack Overflow/Unix StackExchange:** Tag with `ubuntu`, `nvidia`, `hybrid-graphics`
- **NVIDIA Developer Forums:** [forums.developer.nvidia.com](https://forums.developer.nvidia.com/)
- **Arch Wiki Discussion:** While for Arch, many users reference it for troubleshooting

### Bug Reports (if applicable)
- **supergfxd GitHub:** [asus-linux/supergfxctl](https://github.com/asus-linux/supergfxctl) - if you found issues with the tool
- **NVIDIA Driver Feedback:** Report the nvidia-prime blacklist conflict
- **Ubuntu Launchpad:** For ubuntu-drivers or nvidia-prime packaging issues

### Social Media
- **LinkedIn Article:** Great for professional visibility as an ML engineer
- **Medium/Dev.to:** Technical blog post format
- **Twitter/X:** Share with hashtags #Ubuntu #NVIDIA #ASUSROG #Linux

### Title Suggestions for Posting
- "Fixing Random Freezes on ASUS G14 2025 RTX 5070 Ti with Ubuntu 24.04"
- "ASUS ROG Hybrid Graphics Freeze Issue on Linux - SOLVED"
- "Ubuntu 24.04 on ASUS G14: No More Freezes with Proper Hybrid Graphics Setup"
- "How to Configure NVIDIA RTX 50-Series Hybrid Graphics on ASUS ROG Laptops (Ubuntu)"

---

## Credits & Acknowledgments

**Solution developed through systematic troubleshooting and diagnosis:**
- Identified hybrid graphics display routing as root cause
- Implemented proper GPU mode management with supergfxctl
- Resolved nvidia-prime module blacklist conflicts

**Key Projects:**
- [ASUS Linux Project](https://asus-linux.org/) - asusctl and supergfxctl
- [NVIDIA Linux Drivers](https://www.nvidia.com/en-us/drivers/unix/)

---

## License

This guide is released under CC0 1.0 Universal (Public Domain). Feel free to share, modify, and use without attribution.

---

## Changelog

**2025-01-01:** Initial version based on successful fix of ASUS G14 2025 RTX 5070 Ti freeze issue on Ubuntu 24.04.

---

**Questions or improvements?** Please open an issue or pull request if sharing on GitHub!
